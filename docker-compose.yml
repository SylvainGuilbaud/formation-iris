networks:
  irisnetwork:
    ipam:
      driver: default
      config:
        - subnet: 172.0.0.0/24
services:
  iris:
    build:
      context: .
      dockerfile: Dockerfile
      target: final
    restart: always
    container_name: ${iris_container_name}
    hostname: ${iris_container_name}
    ports:
      - 12772:1972
      - 52773:52773
      - 13773:53773
    command: --check-caps false
    # command: --key /key/iris.key
    # environment:
    #   - ISC_DATA_DIRECTORY=/irisdata
    volumes:
      - ./data:/data
      - ./jdbc:/jdbc
      - ./:/home/irisowner/dev
      # - ./src:/app/src
      # - ./:/home/irisowner/dev
      # - ./volumes/irisdata:/irisdata
      # - ./key/iris.key:/key/iris.key
    networks:
      irisnetwork:
        ipv4_address: 172.0.0.10
  # jupyter:
  #   # image: jupyter/datascience-notebook
  #   # image: jupyter/base-notebook
  #   build: 
  #     context: ./jupyter
  #     dockerfile: Dockerfile
  #   restart: always
  #   pull_policy: always
  #   hostname: jupyter
  #   container_name: ${iris_container_name}-jupyter
  #   entrypoint: jupyter lab --ip 0.0.0.0 --port 8888 --allow-root --no-browser --notebook-dir=/data/Notebooks --NotebookApp.token='' --NotebookApp.password='' --NotebookApp.disable_check_xsrf=True 
  #   user: root
  #   environment:
  #       NB_USER: docker_worker
  #       NB_UID: 1008
  #       NB_GID: 1011
  #       CHOWN_HOME: 'yes'
  #       CHOWN_HOME_OPTS: -R
  #   ports:
  #   - "14200:8888" # where Jupyter will be listening
  #   - "14201:6006"
  #   volumes:
  #     - ./jupyter:/data
  mysql: 
    # image: mysql:8.0.30
    image: mysql
    command: --default-authentication-plugin=mysql_native_password
    hostname: mysql
    init: true
    container_name: ${iris_container_name}-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=mysqlpass
    ports:
      - 3306:3306
    volumes:
      - ./mysql:/docker-entrypoint-initdb.d
    networks:
      irisnetwork:
        ipv4_address: 172.0.0.11
  postgres:
    container_name: ${iris_container_name}-postgres
    image: postgres
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./src/sql/postgreSQL:/docker-entrypoint-initdb.d/
      - ./volumes/postgreSQL:/var/lib/postgresql/data
    ports:
      - 5432:5432
    restart: unless-stopped
    healthcheck:
        test: ["CMD", "pg_isready", "-U", "postgres"]
        interval: 30s
        timeout: 30s
        retries: 3
    networks:
      irisnetwork:
        ipv4_address: 172.0.0.12
  ftp_server:
    image: delfer/alpine-ftp-server:latest
    container_name: ${iris_container_name}-ftp-server
    ports:
      - "21:21"
      - "21000-21010:21000-21010"
    volumes: 
      - "./data:/home/app/"
      # - "./data/passwd:/etc/pure-ftpd/passwd"
# uncomment for ssl/tls, see https://github.com/stilliard/docker-pure-ftpd#tls
#      - "/folder_on_disk/ssl:/etc/ssl/private/"
# or ssl/tls with Let's Encrypt (cert and key as two files)
#      - "/etc/letsencrypt/live/<your_server>/cert.pem:/etc/ssl/private/pure-ftpd-cert.pem"
#      - "/etc/letsencrypt/live/<your_server>/privkey.pem:/etc/ssl/private/pure-ftpd-key.pem"
    environment:
      PUBLICHOST: "localhost"
      USERS: "app|youneverknow|/home/app|10000"
      ADDRESS: "172.0.0.100"
# also for ssl/tls:
#      ADDED_FLAGS: "--tls=2"
    restart: always
    networks:
      irisnetwork:
        ipv4_address: 172.0.0.100
  kafka:
    image: 'confluentinc/cp-kafka:5.3.1-1'
    hostname: 'kafka'
    depends_on:
      - 'zookeeper'
    ports:
      - 9092:9092
#      - 9999:9999
    environment:
      - 'KAFKA_BROKER_ID=1'
      - 'KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181'
      - 'KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:29092,PLAINTEXT_HOST://kafka:9092'
      - 'KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      - 'KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT'
      - 'KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1'
      - 'KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1'
      - 'KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1'
#      - 'KAFKA_JMX_OPTS=-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.net.preferIPv4Stack=true -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.rmi.port=9999 -Djava.rmi.server.hostname=ip here'
    restart: 'on-failure'
  kafka-manager:
    image: 'eduard93/kafka-manager-demo:latest'
    hostname: 'kafka-manager'
    depends_on:
      - 'kafka'
    environment:
      - 'KAFKA_SERVERS_URL=kafka:29092'
    ports:
      - 8082:8082
    restart: 'on-failure'
  zookeeper:
    image: 'confluentinc/cp-zookeeper:5.3.1-1'
    hostname: 'zookeeper'
    ports:
      - 2181:2181
    environment:
      - 'ZOOKEEPER_CLIENT_PORT=2181'
      - 'ZOOKEEPER_TICK_TIME=2000'
    restart: 'on-failure'



